# Branch Custom Export API 가이드

    Modified on: Feb 28, 2019
---

## 개요
기존 Attribution Analytics(이후 AA)에서 제공되던 **Reporting API**는 Branch에서 최소한의 변경으로 최대한 동일한 가능을 지원할 수 있도록 개발된 **Custom Export API**로 쉽게 마이그레이션이 가능합니다.
현재 문서는 기존 Reporting API 가이드를 기준으로 작성되었으며, 추후 일부 내용이 변경될 수 있습니다.

Reporting API의 마이그레이션에 관련된 자세한 사항은 [Export API Migration Guide(번역본)](custom-export-api-guide-ko.md)을 함께 참고 해주시기 바랍니다.

## Data Freshness
* 내부 지표를 통해서 데이터의 적시성을 관리하고 있습니다.
* 각각의 로그 타입별(Log, Actuals) 신규데이터가 업데이트 되는 시기가 다르며,
	추후 구현 변경에 의해서 업데이트 주기가 변경이 될 수 있습니다.
* 데이터의 업데이트 지연은 데이터 처리, 서버로드 및 여러가지 요인에 의해서 발생할 수 있으며,
	지연은 각각의 리포트 별로 서로 독립적입니다.
* 엔지니어링팀에서는 내부적으로 관리되는 지표에 의한 허용 가능한 범위를 넘는 지연이 발생할 경우
	이를 즉시 해결하기위해서 최선의 노력을 다하고 있습니다.

## Data availability
  접근 가능한 데이터의 범위는 추후 내부적인 정책,구현 변경이나 성능향상을 위해서 변경될 수 있습니다.

* Actuals : (Aggregated Report, 집계 리포트)
    * 데이터 접근 가능 기간: 이전 6개월 (추후 변경가능)
* Logs :
    * 데이터 접근 가능 기간: 이전 6개월 (추후 변경가능)
    * GDPR관련
        * **광고아이디를 포함한 일부 민감한 데이터는 현재 7일 이후 Salt와 함께 해슁(원본복구불가)**됩니다. (향후 60일 이후에 해슁되도록 변경될 예정)
        * 참고로, Branch와 AA는 광고아이디에 대해서 다르게 처리되고 있습니다. AA에서는 광고아이디 원본 수집시 MD5, SHA1, SHA256으로 해슁된 광고아이디가 별도 필드로 자동 저장되었으며, EU지역으로 판단된 경우 수집된 광고아이디 원본은 삭제되었습니다.

## Log 및 집계 데이터
* 일반적으로 현재 시각부터 1~2 시간 이전의 데이터에 접근할 수 있습니다.	데이터 처리에 대한 로드가 높아질 경우에는 일시적으로 이보다 좀더 지연될 수 있습니다.
  대부분의 경우, 6시간 이후에는 해당 시간대의 데이터가 모두 업데이트 되도록 관리되고 있습니다.
* 단기분석을 위한 익스포트시 주의 사항 :
    * 현재로부터 6시간 이내의 데이터의 경우는 해당 시간대의 모든 데이터가 익스포트 되지 않을 수 있으므로 단기적인 분석 용도로만 사용하시는 것이 권장됩니다.
* 장기분석을 위한 익스포트시 주의 사항 :
    * 6시간 이전의 데이터의 경우는 특별한 이슈가 없는한 해당 범위의 데이터를 거의 모두 익스포트되므로 장기분석 목적으로 저장 할 수 있습니다.
    *	아주 드물게 심각한 장애로 인한 데이터 지연이 발생할 수도 있기 때문에 이에 대응하기 위해 동일한 기간의 데이터를 일주일 후에 다시 한번
     	익스포트해서 기존 익스포트에서 포함되지 않았던 데이터를 추가 업데이트 하는 방법도 고려할 수 있습니다.

## Reporting API (V3)를 통한 로그 익스포트

Technical Document
   > Reporting API Docs
        https://developers.tune.com/reporting/
   > V2 to V3 migration guide.
        https://developers.tune.com/reporting-docs/log-endpoints-v2-to-v3-migration-guide/
   > Supported Log Export Endpoints
        https://developers.tune.com/reporting/exports/

API Rate-limit : https://developers.tune.com/reporting-docs/reporting-api-rate-limits/
  - Search/export endpoint : 시간당 180회
  - Polling endpoint (진행중인 작업의 진행상태 확인) : 시간당 480회
  % 빈도제한에 의해서 요청이 실패할 경우, 응답에 제한이 해제되는 시각 정보가 리턴됩니다.

요청시 리턴되는 최대 레코드 제한
 - Search Endpoint : 5000건
 - Export Endpoint : 2백만건
	% 각각의 로그별 1시간에 2백만건 이상의 레코드가 있어 더 이상 시간범위를 줄이기 힘들 경우,
    	내부 검토를 거쳐서 필요하다고 판단될 경우 2백만건 제한을 상향 해드릴 수 있습니다.)

요청시 최대 레코드 제한을 넘는 경우 처리 방법
   > 리턴된 레코드의 갯수가 최대 레코드 제한 갯수(2백만건)와 동일하다면,
    	이것은 최대 레코드 제한에 의해서 일부 레코드가 리턴되지 않았다는 것을 의미합니다.
   > 요청시 최대 레코드 제한을 넘는 레코드가 있다면:
    	앱별 또는 이벤트별로 나누어서 요청하거나,
        일반적인 일단위 대신 더 짧은 시간범위를 나누어서 요청 하시기 바랍니다.

HTTP응답이 200이 아닐 경우 처리방법
  - 4xx : 리퀘스트 자체에 문제가 있다는 것입니다. 개발팀에서는 리퀘스트에 문제가 있는지 확인하세요.
  - 5xx : TUNE의 서비스에 문제가 있음을 의미합니다.
      	   일정 기간 대기 후에 다시 요청하시는 것을 권장드립니다.
         	예를들어 1시간 이상 지속되어 일시적인 이슈가 아니라고 생각되시면
          	TMC Support Team(tmcsupport@tune.com) 으로 메일을 보내 주시기 바랍니다.

익스포트가 처리되는 방법:
 - 익스포트가 요청되면 시스템은 해당 작업에 대해서 고유한 Job ID를 할당한뒤 작업큐에 저장합니다.
	작업큐에 저장된 작업들은 이전에 요청된 작업들 완료되면 이후 실제 큐에서 나와 처리가 되게 됩니다.
 - 작업 큐는 여러 광고주들과 공유하게 되며, 각각의 작업은 큐에 FIFO방식으로 처리됩니다.
 - 동시에 너무 많은 작업이 요청될 경우에는 작업들이 큐에서 얼마간 대기 했다가 처리되며,
	이것은 TUNE에서 동시에 처리할수 있는 작업에 제한이 있기 때문입니다.
 - 익스포트가 요청시 리턴된 Job ID로, 작업이 완료될 때까지 계속해서 진행상태를 확인하게 됩니다.
 - 진행상태를 확인하는 경우 시간당 480번으로 제한이 되며, 1분에 한번씩 작업 상태를 확인하시는것이
 	권장됩니다.
 - 작업의 “status”는 “pending”, “running”, “complete”, “fail” 중 하나가 리턴됩니다.
 - 해당 작업이 큐에서 대기중 이라면 “pending” status 가 리턴됩니다.
 	추후 작업이 처리중일 경우 “running” status 로 변경됩니다.

“Pending” 상태가 오래 지속될 때 처리방법
 - 이전에 언급 되었듯이, 너무 많은 익스포트 요청이 한번에 들어오면, 일부 작업들은 큐에서 대기하게 되며
 	이 경우 “pending” 상태가 리턴됩니다.
 	이런 경우  수십분또는 1시간 이상 “pending”상태가 리턴될 수 있습니다.
 	비정상적으로 너무 오래 (예를들어 6시간 이상) “pending” 상태에 있다면,
  	서포트 팀(tmcsupport@team)으로 해당 Job ID와 함께 문의 해주시기 바랍니다.
 - “pending” 상태의 작업은 서버로드에 따라 시간이 걸릴수 있으나 결국은 “running” 상태로 변경됩니다.
 	그러므로 “fail” 상태가 리턴되는 경우가 아니라면, 해당 작업이 최종적으로 “complete” 상태가 될때까지
 	계속 상태를 확인하며 대기하여야 합니다.
 - “pending” 상태가 오래된다고 해서, 동일한 익스포트를 다시 요청하는것은 꼭 지양되어야 합니다.
 	새롭게 익스포트를 요청해도 신규작업은 기존 작업의 뒤에서 대기 하게 되므로,
 	먼저 큐에 들어간 “pending”상태의 작업이 항상 먼저 처리됨을 유의하시기 바랍니다.
 	현재는 생성된 작업을 API를 통해서 강제 종료할수 있는 방법은 제공되고 있지 않습니다.
 - 작업 큐는 여러 광고주와 함께 공유되므로, 매시 정각과 같이 요청이 몰리는 시간을 피하는 것은 좋은 방법이
	될 수 있습니다.
 - 여러 종류의 리포트나 로그를 익스포트 할 경우, 한번에 모든 리포트/Log에 대한 요청을 보내는 것보다
 	각각의 리포트/로그를 한번에 하나씩 순차적으로 익스포트 하는것이 바람직 합니다.
